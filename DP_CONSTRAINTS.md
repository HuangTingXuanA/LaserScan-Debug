# DP算法的三大约束

## 1. Cost约束（代价约束）

**定义**：切片与光平面的几何匹配代价

**实现**：
```cpp
if (cost_matrix[i][k] < COST_INVALID_) {
    // 只有代价有效时才能匹配
}
```

**含义**：
- 如果切片i无法与平面k匹配（遮挡、干扰等），cost = INVALID
- 只有cost < INVALID的组合才能被选择

**例子**：
```
切片S5在左图可见，但在右图被遮挡
→ cost_matrix[5][k] = INVALID for all k
→ S5无法被匹配，只能跳过
```

## 2. 光平面顺序约束（单调不减）

**定义**：按x坐标排序后，匹配的光平面索引必须单调不减

**物理意义**：
- 激光线从左到右扫描
- 依次穿过不同深度的光平面（P0近，P6远）
- 不可能先穿过P3，再回到P1

**实现**：
```cpp
for (int j = 0; j <= k; ++j) { // ← 关键约束
    // 只允许从平面j转移到平面k，其中 j <= k
}
```

**例子**：
```
合法序列：
  切片: S0  S1  S2  S3  S4  S5  S6
  平面: P0  P0  P1  P1  P2  P2  P2
        ✓   ✓   ✓   ✓   ✓   ✓   ✓
  说明：0 <= 0 <= 1 <= 1 <= 2 <= 2 <= 2 ✓

非法序列：
  切片: S0  S1  S2  S3  S4  S5  S6
  平面: P0  P1  P0  P2  P1  P3  P2
        ✓   ✓   ✗   ✓   ✗   ✓   ✗
  说明：P1→P0回退 ✗，P2→P1回退 ✗，P3→P2回退 ✗
```

**DP中的体现**：
```cpp
// 状态转移时
if (切片i-1匹配到平面j) {
    切片i只能匹配到平面k，其中 k >= j
}

// 跳过切片时
if (切片i-1的状态是平面j) {
    切片i跳过后，状态只能是平面k，其中 k >= j
}
```

## 3. 切片拓扑顺序约束（x坐标排序）

**定义**：切片已按x坐标排序，DP按这个顺序处理

**含义**：
- 切片索引i < j 意味着 slices[i].center_pt.x < slices[j].center_pt.x
- DP从i=0到i=N-1依次处理
- 保证了空间上的从左到右顺序

**与光平面顺序约束的关系**：
```
空间顺序（x坐标）：
  左 ←─────────────────────→ 右
     S0  S1  S2  S3  S4  S5

光平面深度顺序：
  近 ←─────────────────────→ 远
     P0  P1  P2  P3  P4  P5

组合约束：
  从左到右扫描时，只能从近到远穿过光平面
  → 光平面索引单调不减
```

## 约束的协同作用

### 场景1：正常匹配
```
切片: S0(x=10) S1(x=12) S2(x=14) S3(x=16)
线：  L1       L1       L1       L1
Cost: P0有效   P0有效   P1有效   P1有效

DP过程：
  S0 → P0 (起点)
  S1 → P0 (j=0, k=0, j<=k ✓)
  S2 → P1 (j=0, k=1, j<=k ✓)
  S3 → P1 (j=1, k=1, j<=k ✓)

结果：P0 → P0 → P1 → P1 ✓ 单调不减
```

### 场景2：遮挡跳过
```
切片: S0(x=10) S1(x=12) S2(x=14) S3(x=16)
线：  L1       L1       L2       L2
Cost: P0有效   P0有效   全无效   P1有效

DP过程：
  S0 → P0 (起点)
  S1 → P0 (j=0, k=0, j<=k ✓)
  S2 → 跳过 (cost全无效)
  S3 → P1 (从S1的P0转移，j=0, k=1, j<=k ✓)

结果：P0 → P0 → [跳过] → P1 ✓ 单调不减
```

### 场景3：x距离约束
```
切片: S0(x=10) S1(x=12) S2(x=30) S3(x=32)
线：  L1       L1       L2       L2
Cost: P0有效   P0有效   P0有效   P0有效

DP过程：
  S0 → P0 (起点)
  S1 → P0 (同线同平面，无惩罚)
  S2 → P0? (不同线同平面，dx=18>15 → 惩罚1000)
       → P1? (异平面，惩罚2.0) ← 选择这个
  S3 → P1 (同线同平面)

结果：P0 → P0 → P1 → P1 ✓ 单调不减
说明：x距离约束防止了S1-S2匹配同一平面
```

### 场景4：假连通
```
切片: S0(x=10) S1(x=12) S2(x=14) S3(x=16)
线：  L1       L1       L1       L1
Cost: P0有效   P0有效   P0,P1都有效   P1有效

DP过程：
  S0 → P0 (起点)
  S1 → P0 (同线同平面)
  S2 → P0 (cost=0.5, 同线同平面，无惩罚)
       → P1 (cost=0.6, 同线异平面，惩罚5.0)
       选择P0 (总代价更低)
  S3 → P1 (从S2的P0转移，j=0, k=1, j<=k ✓)

结果：P0 → P0 → P0 → P1 ✓ 单调不减
说明：允许同线切换平面，但有惩罚
```

## 总结

三大约束确保了：
1. **Cost约束**：只匹配几何上合理的组合
2. **光平面顺序约束**：符合物理规律（单调不减）
3. **拓扑顺序约束**：按空间顺序处理

这三个约束共同作用，使得DP能够：
- 正确处理干扰线和遮挡
- 保证物理合理性
- 处理假连通问题
- 防止鬼影重叠
